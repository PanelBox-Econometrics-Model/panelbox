name: R Validation Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'panelbox/models/discrete/**'
      - 'panelbox/models/count/**'
      - 'panelbox/models/censored/**'
      - 'tests/validation/**'
      - '.github/workflows/r_validation.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'panelbox/models/discrete/**'
      - 'panelbox/models/count/**'
      - 'panelbox/models/censored/**'
      - 'tests/validation/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  validate-against-r:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3.0'

    - name: Cache R packages
      uses: actions/cache@v4
      with:
        path: ${{ env.R_LIBS_USER }}
        key: ${{ runner.os }}-r-4.3.0-${{ hashFiles('tests/validation/discrete/scripts/requirements.R') }}
        restore-keys: |
          ${{ runner.os }}-r-4.3.0-

    - name: Install R dependencies
      run: |
        Rscript -e "install.packages('remotes')"
        Rscript -e "remotes::install_cran(c('pglm', 'censReg', 'MASS', 'margins', 'jsonlite', 'plm'))"

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-cov numpy pandas

    - name: Generate R reference results
      run: |
        cd tests/validation/discrete
        if [ -d "scripts" ]; then
          for script in scripts/*.R; do
            if [ -f "$script" ]; then
              echo "Running $script"
              Rscript "$script"
            fi
          done
        fi

    - name: Run validation tests
      run: |
        pytest tests/validation/discrete/ -v --tb=short

    - name: Upload validation reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: validation-reports
        path: |
          tests/validation/discrete/VALIDATION_REPORT.md
          tests/validation/discrete/data/*.json

    - name: Check validation tolerances
      run: |
        python -c "
import json
import os
import sys

# Check if validation report exists
report_path = 'tests/validation/discrete/VALIDATION_REPORT.md'
if os.path.exists(report_path):
    with open(report_path, 'r') as f:
        content = f.read()
        if 'FAILED' in content or 'ERROR' in content:
            print('⚠️  Validation issues found. Check the validation report.')
            sys.exit(1)
        else:
            print('✅ All validation tests passed within tolerance!')
else:
    print('⚠️  Validation report not found')
"

  coverage-check:
    runs-on: ubuntu-latest
    needs: validate-against-r

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install -e ".[test]"

    - name: Run all tests with coverage
      run: |
        pytest --cov=panelbox --cov-report=xml --cov-report=term-missing --cov-fail-under=85

    - name: Generate coverage report
      run: |
        coverage report -m
        echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        coverage report --format=markdown >> $GITHUB_STEP_SUMMARY || coverage report >> $GITHUB_STEP_SUMMARY
